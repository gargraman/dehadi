# HireConnect Flutter Development Guide

This guide provides detailed information for developers working on the HireConnect Flutter mobile application.

## Table of Contents

1. [Architecture Overview](#architecture-overview)
2. [API Integration](#api-integration)
3. [State Management](#state-management)
4. [Authentication Flow](#authentication-flow)
5. [Model Definitions](#model-definitions)
6. [Payment Integration](#payment-integration)
7. [Development Workflow](#development-workflow)
8. [Testing Guidelines](#testing-guidelines)
9. [Common Patterns](#common-patterns)

## Architecture Overview

### Directory Structure

```
lib/
├── config/          # Configuration (API endpoints, constants)
├── models/          # Data models (User, Job, Payment, etc.)
├── screens/         # UI screens
├── services/        # Business logic & API clients
├── utils/           # Utility functions
└── widgets/         # Reusable UI components
```

### Design Patterns

- **Service Pattern**: Business logic separated into service classes
- **Repository Pattern**: API calls abstracted in service layer
- **Provider Pattern**: State management using Flutter Provider
- **Singleton Services**: Auth and API services are static classes

## API Integration

### Configuration

API endpoints are configured in `lib/config/api_config.dart`:

```dart
class ApiConfig {
  static const String baseUrl = String.fromEnvironment(
    'API_BASE_URL',
    defaultValue: 'http://localhost:8080/api',
  );
}
```

### Making API Calls

All API calls go through `ApiService`:

```dart
// Example: Get all jobs
final jobs = await ApiService.getJobs(
  workType: 'plumber',
  location: 'Mumbai',
  status: 'open',
);

// Example: Create a job application
final application = JobApplication(
  id: '', // Will be generated by backend
  jobId: jobId,
  workerId: currentUser.id,
  status: 'pending',
  message: 'I am interested in this job',
  createdAt: DateTime.now(),
);

final createdApp = await ApiService.createApplication(application);
```

### Authentication

Authentication is handled by `AuthService`:

```dart
// Register
final user = await AuthService.register(
  username: 'worker123',
  password: 'securepassword',
  role: 'worker',
  fullName: 'John Doe',
  phone: '+919876543210',
);

// Login
final user = await AuthService.login(
  username: 'worker123',
  password: 'securepassword',
);

// Check auth status
final isLoggedIn = await AuthService.isLoggedIn();

// Get current user
final user = await AuthService.getCurrentUser();

// Logout
await AuthService.logoutUser();
```

### Session Management

- Sessions are managed using Express session cookies
- User data is cached in `SharedPreferences` for offline access
- Automatic logout on 401 responses

## State Management

### Current Implementation

The app currently uses:
- `StatefulWidget` for local component state
- `SharedPreferences` for persistent user data
- Service classes for API state

### Future Enhancement

Consider migrating to Provider for global state:

```dart
// Example Provider pattern
class JobProvider extends ChangeNotifier {
  List<Job> _jobs = [];
  
  Future<void> fetchJobs() async {
    _jobs = await ApiService.getJobs();
    notifyListeners();
  }
}
```

## Authentication Flow

### Flow Diagram

```
App Start
   ↓
Check Auth Status (AuthWrapper)
   ↓
   ├─ Not Logged In → LoginScreen
   │                     ↓
   │                  Login/Register
   │                     ↓
   └─ Logged In → Check User Role
                     ↓
      ├─ Worker → HomeScreen (with bottom navigation)
      └─ Employer → EmployerDashboardScreen
```

### Implementation

See `lib/main.dart` for the `AuthWrapper` and `HomeOrEmployerWrapper` widgets.

## Model Definitions

All models match the backend PostgreSQL schema defined in `shared/schema.ts`.

### User Model

```dart
class User {
  final String id;
  final String username;
  final String fullName;
  final String phone;
  final String role;           // 'worker', 'employer', 'ngo', 'admin'
  final String? language;      // 'en', 'hi', 'bn', etc.
  final String? location;
  final List<String>? skills;
  final String? aadhar;
}
```

### Job Model

```dart
class Job {
  final String id;
  final String employerId;
  final String title;
  final String description;
  final String workType;       // 'mason', 'electrician', 'plumber', etc.
  final String location;
  final String? locationLat;
  final String? locationLng;
  final String wageType;       // 'daily', 'hourly', 'fixed'
  final int wage;              // In smallest currency unit (paise)
  final int? headcount;
  final List<String>? skills;
  final String status;         // 'open', 'in_progress', 'awaiting_payment', 
                               // 'paid', 'completed', 'cancelled'
  final String? assignedWorkerId;
  final DateTime? startedAt;
  final DateTime? completedAt;
  final DateTime createdAt;
}
```

### Job Status Lifecycle

```
open → in_progress → awaiting_payment → paid → completed
  ↓
cancelled (can be cancelled at any stage)
```

### Payment Model

```dart
class Payment {
  final String id;
  final String jobId;
  final String employerId;
  final String workerId;
  final int amount;                    // In paise (1 INR = 100 paise)
  final String currency;               // 'INR'
  final String status;                 // 'pending', 'processing', 'completed', 
                                       // 'failed', 'refunded'
  final String? paymentMethod;         // 'upi', 'razorpay', 'card', etc.
  final String? razorpayOrderId;
  final String? razorpayPaymentId;
  final String? razorpaySignature;
  final String? failureReason;
  final DateTime? createdAt;
  final DateTime? paidAt;
}
```

## Payment Integration

### Razorpay Integration

The app uses Razorpay for secure payments:

```dart
// 1. Create Razorpay order
final orderData = await ApiService.createRazorpayOrder(
  amount: 80800,      // Amount in paise (₹500.00)
  currency: 'INR',
);

// 2. Open Razorpay checkout (requires razorpay_flutter package)
// Note: This requires adding the razorpay_flutter dependency

// 3. Verify payment on backend
final isVerified = await ApiService.verifyPayment({
  'razorpay_order_id': orderData['orderId'],
  'razorpay_payment_id': paymentId,
  'razorpay_signature': signature,
  'jobId': jobId,
});
```

### Adding Razorpay Package

To enable payment UI:

1. Add to `pubspec.yaml`:
   ```yaml
   dependencies:
     razorpay_flutter: ^1.3.6
   ```

2. Implementation example:
   ```dart
   import 'package:razorpay_flutter/razorpay_flutter.dart';

   final razorpay = Razorpay();
   
   razorpay.on(Razorpay.EVENT_PAYMENT_SUCCESS, (response) {
     // Verify with backend
     ApiService.verifyPayment(response);
   });
   
   razorpay.on(Razorpay.EVENT_PAYMENT_ERROR, (response) {
     // Handle error
   });
   
   var options = {
     'key': 'YOUR_RAZORPAY_KEY',
     'amount': 80800,
     'name': 'HireConnect',
     'order_id': orderData['orderId'],
   };
   
   razorpay.open(options);
   ```

## Development Workflow

### Setting Up Development Environment

1. **Install Flutter**:
   ```bash
   flutter doctor
   ```

2. **Get dependencies**:
   ```bash
   cd hireconnect_flutter
   flutter pub get
   ```

3. **Start backend server** (in main project directory):
   ```bash
   npm run dev
   ```

4. **Run Flutter app** with backend URL:
   ```bash
   # For Android emulator
   flutter run --dart-define=API_BASE_URL=http://10.0.2.2:8080/api
   
   # For iOS simulator
   flutter run --dart-define=API_BASE_URL=http://localhost:8080/api
   ```

### Hot Reload vs Hot Restart

- **Hot Reload** (`r`): Updates UI without losing state
- **Hot Restart** (`R`): Resets app state
- **Full Restart** (`q` then `flutter run`): When changing dependencies

### Code Formatting

```bash
# Format all Dart files
flutter format lib/

# Analyze code
flutter analyze
```

## Testing Guidelines

### Unit Tests

```dart
// Example: Testing User model
test('User.fromJson creates valid User', () {
  final json = {
    'id': '123',
    'username': 'worker1',
    'fullName': 'John Doe',
    'phone': '+919876543210',
    'role': 'worker',
  };
  
  final user = User.fromJson(json);
  
  expect(user.id, '123');
  expect(user.username, 'worker1');
  expect(user.role, 'worker');
});
```

### Widget Tests

```dart
// Example: Testing LoginScreen
testWidgets('LoginScreen has username and password fields', (tester) async {
  await tester.pumpWidget(MaterialApp(home: LoginScreen()));
  
  expect(find.byType(TextField), findsNWidgets(2));
  expect(find.text('Login'), findsOneWidget);
});
```

### Integration Tests

Place in `integration_test/` directory:

```dart
void main() {
  testWidgets('Complete login flow', (tester) async {
    // Test full user journey
  });
}
```

## Common Patterns

### Error Handling

```dart
try {
  final jobs = await ApiService.getJobs();
  // Handle success
} catch (e) {
  print('Error fetching jobs: $e');
  // Show error to user
  ScaffoldMessenger.of(context).showSnackBar(
    SnackBar(content: Text('Failed to load jobs')),
  );
}
```

### Loading States

```dart
class MyScreen extends StatefulWidget {
  @override
  State<MyScreen> createState() => _MyScreenState();
}

class _MyScreenState extends State<MyScreen> {
  bool _isLoading = true;
  List<Job> _jobs = [];
  
  @override
  void initState() {
    super.initState();
    _loadJobs();
  }
  
  Future<void> _loadJobs() async {
    setState(() => _isLoading = true);
    try {
      final jobs = await ApiService.getJobs();
      setState(() {
        _jobs = jobs;
        _isLoading = false;
      });
    } catch (e) {
      setState(() => _isLoading = false);
      // Handle error
    }
  }
  
  @override
  Widget build(BuildContext context) {
    if (_isLoading) {
      return Center(child: CircularProgressIndicator());
    }
    
    return ListView.builder(
      itemCount: _jobs.length,
      itemBuilder: (context, index) {
        return JobCard(job: _jobs[index]);
      },
    );
  }
}
```

### Navigation

```dart
// Navigate to new screen
Navigator.push(
  context,
  MaterialPageRoute(
    builder: (context) => JobDetailsScreen(jobId: job.id),
  ),
);

// Navigate back
Navigator.pop(context);

// Replace current screen
Navigator.pushReplacement(
  context,
  MaterialPageRoute(builder: (context) => HomeScreen()),
);
```

## API Response Formats

All API responses follow consistent patterns:

### Success Response
```json
{
  "id": "uuid",
  "field1": "value1",
  "field2": "value2"
}
```

### List Response
```json
[
  { "id": "1", "name": "Item 1" },
  { "id": "2", "name": "Item 2" }
]
```

### Error Response
```json
{
  "message": "Error description",
  "error": "Error type"
}
```

## Environment-Specific Configuration

### Development
- Debug logs enabled
- Localhost backend
- Extended timeouts

### Production
- Debug logs disabled
- Production backend URL
- Optimized timeouts
- Error reporting

## Performance Optimization

### Image Loading

```dart
// Use cached network images
CachedNetworkImage(
  imageUrl: imageUrl,
  placeholder: (context, url) => CircularProgressIndicator(),
  errorWidget: (context, url, error) => Icon(Icons.error),
)
```

### List Performance

```dart
// Use ListView.builder for large lists
ListView.builder(
  itemCount: items.length,
  itemBuilder: (context, index) {
    return ListTile(title: Text(items[index]));
  },
)
```

### Memory Management

- Dispose controllers in `dispose()`
- Cancel timers and subscriptions
- Clear large lists when not needed

## Security Best Practices

1. **Never hardcode API keys** - Use environment variables
2. **Validate user input** - Always validate before API calls
3. **Secure storage** - Use `flutter_secure_storage` for sensitive data
4. **HTTPS only** - Always use HTTPS in production
5. **Session timeout** - Implement automatic logout

## Troubleshooting

### Common Issues

**Build errors after adding dependencies**
```bash
flutter clean
flutter pub get
flutter run
```

**Android connection issues**
- Use `10.0.2.2` instead of `localhost`
- Check Android manifest for internet permission

**iOS connection issues**
- Update `Info.plist` for network permissions
- Check iOS simulator network settings

**State not updating**
- Ensure `setState()` is called
- Check if widget is mounted before setState
- Verify data is actually changing

## Resources

- [Flutter Documentation](https://flutter.dev/docs)
- [Dart Language Tour](https://dart.dev/guides/language/language-tour)
- [Material Design](https://material.io/design)
- [Razorpay Flutter Plugin](https://pub.dev/packages/razorpay_flutter)

---

**Questions?** Refer to the main project documentation or create an issue in the repository.
